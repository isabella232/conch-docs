



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.4, mkdocs-material-2.9.1">
    
    
      
        <title>Writing Validations - Conch</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.ba0fd1a6.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.6079476c.css">
      
      
        
        
        <meta name="theme-color" content="#ff7043">
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="deep-orange" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#writing-deploying-and-testing-a-conch-validation" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Conch" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Conch
              </span>
              <span class="md-header-nav__topic">
                Writing Validations
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    Conch
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../about/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../architecture/" title="Architecture" class="md-nav__link">
      Architecture
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../features/" title="Features" class="md-nav__link">
      Features
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../roadmap/" title="Roadmap" class="md-nav__link">
      Roadmap
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Using Conch
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Using Conch
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../usage/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../usage/ui/" title="Web UI" class="md-nav__link">
      Web UI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../usage/cli/" title="CLI" class="md-nav__link">
      CLI
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Conch Relay Devices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Conch Relay Devices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../relay/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../relay/setup/" title="Setup" class="md-nav__link">
      Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../relay/usage/" title="Usage" class="md-nav__link">
      Usage
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../relay/status/" title="Status and Icons" class="md-nav__link">
      Status and Icons
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Development
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Development
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Writing Validations
      </label>
    
    <a href="./" title="Writing Validations" class="md-nav__link md-nav__link--active">
      Writing Validations
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview-of-steps" title="Overview of steps" class="md-nav__link">
    Overview of steps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-the-conch-repository" title="Setting up the Conch Repository" class="md-nav__link">
    Setting up the Conch Repository
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-new-validation" title="Creating a new Validation" class="md-nav__link">
    Creating a new Validation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-validation-logic" title="Writing validation logic" class="md-nav__link">
    Writing validation logic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validating-input" title="Validating input" class="md-nav__link">
    Validating input
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dispatching-on-device-attributes" title="Dispatching on Device Attributes" class="md-nav__link">
    Dispatching on Device Attributes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-unit-tests-for-validations" title="Writing unit tests for Validations" class="md-nav__link">
    Writing unit tests for Validations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-the-validation" title="Deploying the Validation" class="md-nav__link">
    Deploying the Validation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-validations-with-the-conch-shell" title="Using Validations with the Conch Shell" class="md-nav__link">
    Using Validations with the Conch Shell
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#listing-validations" title="Listing validations" class="md-nav__link">
    Listing validations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-a-validation-with-a-device" title="Testing a validation with a device" class="md-nav__link">
    Testing a validation with a device
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-and-managing-validation-plans" title="Creating and managing validation plans" class="md-nav__link">
    Creating and managing validation plans
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-validation-plans" title="Testing validation plans" class="md-nav__link">
    Testing validation plans
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tips-for-writing-validations" title="Tips for Writing Validations" class="md-nav__link">
    Tips for Writing Validations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#provide-user-friendly-hints" title="Provide user-friendly hints" class="md-nav__link">
    Provide user-friendly hints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#die-fast-and-loud" title="Die fast and loud" class="md-nav__link">
    Die fast and loud
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write-small-validations" title="Write small validations" class="md-nav__link">
    Write small validations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview-of-steps" title="Overview of steps" class="md-nav__link">
    Overview of steps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-the-conch-repository" title="Setting up the Conch Repository" class="md-nav__link">
    Setting up the Conch Repository
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-new-validation" title="Creating a new Validation" class="md-nav__link">
    Creating a new Validation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-validation-logic" title="Writing validation logic" class="md-nav__link">
    Writing validation logic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validating-input" title="Validating input" class="md-nav__link">
    Validating input
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dispatching-on-device-attributes" title="Dispatching on Device Attributes" class="md-nav__link">
    Dispatching on Device Attributes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-unit-tests-for-validations" title="Writing unit tests for Validations" class="md-nav__link">
    Writing unit tests for Validations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-the-validation" title="Deploying the Validation" class="md-nav__link">
    Deploying the Validation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-validations-with-the-conch-shell" title="Using Validations with the Conch Shell" class="md-nav__link">
    Using Validations with the Conch Shell
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#listing-validations" title="Listing validations" class="md-nav__link">
    Listing validations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-a-validation-with-a-device" title="Testing a validation with a device" class="md-nav__link">
    Testing a validation with a device
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-and-managing-validation-plans" title="Creating and managing validation plans" class="md-nav__link">
    Creating and managing validation plans
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-validation-plans" title="Testing validation plans" class="md-nav__link">
    Testing validation plans
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tips-for-writing-validations" title="Tips for Writing Validations" class="md-nav__link">
    Tips for Writing Validations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#provide-user-friendly-hints" title="Provide user-friendly hints" class="md-nav__link">
    Provide user-friendly hints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#die-fast-and-loud" title="Die fast and loud" class="md-nav__link">
    Die fast and loud
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write-small-validations" title="Write small validations" class="md-nav__link">
    Write small validations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="writing-deploying-and-testing-a-conch-validation">Writing, Deploying, and Testing a Conch Validation<a class="headerlink" href="#writing-deploying-and-testing-a-conch-validation" title="Permanent link">&para;</a></h1>
<h3 id="overview-of-steps">Overview of steps<a class="headerlink" href="#overview-of-steps" title="Permanent link">&para;</a></h3>
<ol>
<li>Create a sub-class of <code>Conch::Validation</code>, the Validation base class. Set
   the <code>name</code>, <code>version</code>, <code>description</code>, and <code>category</code> fields, and write a
   <code>validate</code> method. The <code>validate</code> method body should register one or many
   results or an error.</li>
<li>Create a test file in <code>t/validation</code>. Use the <code>Test::Conch::Validation</code> test
   harness to write a test cases for your new validation. Verify it works as
   expected, especially if there are edge cases in the logic.</li>
<li>Commit the validation and validation test on a branch. <a href="https://github.com/joyent/conch/pulls">Create a pull
   request in the Conch repository</a>.
   Request a review.</li>
<li>Once your pull request has been reviewed, merged into master, and deployed,
   the validation is available on the system and via the API.</li>
<li>Using the <a href="https://github.com/joyent/conch-shell">Conch Shell CLI tool</a>, you
   can do the following:<ol>
<li>List available validations. <code>conch validations</code></li>
<li>Test a validation against a device using supplied data. <code>conch
   validation VALIDATION_ID test DEVICE_ID</code></li>
<li>Add a validation to a validation plan. <code>conch validation-plan
   VALIDATION_PLAN add-validation VALIDATION_ID</code></li>
</ol>
</li>
</ol>
<p>Documentation for the <a href="https://github.com/joyent/conch/blob/master/Conch/docs/validation/BaseValidation.md">Validation base class</a>
and <a href="https://github.com/joyent/conch/blob/master/Conch/docs/validation/TestingValidations.md">Validation test harness</a>
are useful references for writing and testing a new Conch Validation.</p>
<h2 id="setting-up-the-conch-repository">Setting up the Conch Repository<a class="headerlink" href="#setting-up-the-conch-repository" title="Permanent link">&para;</a></h2>
<p>All Conch Validations are code modules committed in the <a href="https://github.com/joyent/conch">Conch
repository</a>. To add new validations, you must
create a local clone of the repository and add new validations as files in the
repository.</p>
<p>Clone the repository locally and set it's path to your working directory. All
file paths in this tutorial are relative to the root of the repository.</p>
<p>To build and run Conch locally, Perl version 5.26.0,
<a href="http://search.cpan.org/~miyagawa/Carton-v1.0.28/lib/Carton.pm">Carton</a>, and
<a href="https://yarnpkg.com">yarn</a> are all required to be installed on your system.</p>
<p>To build conch, run <code>make build</code> in <code>Conch/</code>. <code>make test</code> runs all tests,
including validation tests. To run the Conch server, run <code>make run</code> in
<code>Conch/</code>. All valid Conch Validations are automatically loaded when the Conch
server is started.</p>
<h2 id="creating-a-new-validation">Creating a new Validation<a class="headerlink" href="#creating-a-new-validation" title="Permanent link">&para;</a></h2>
<p>Let's start by creating a simple yet valid validation. Create and write the
following code to the file <code>Conch/lib/Conch/Validation/MyValidation.pm</code>:</p>
<div class="codehilite"><pre><span></span><span class="k">package</span> <span class="nn">Conch::Validation::MyValidation</span><span class="p">;</span>

<span class="k">use</span> <span class="nn">Mojo::Base</span> <span class="s">&#39;Conch::Validation&#39;</span><span class="p">;</span>

<span class="n">has</span> <span class="s">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;my_validation_name&#39;</span><span class="p">;</span>
<span class="n">has</span> <span class="s">&#39;version&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">has</span> <span class="s">&#39;category&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;EXAMPLE&#39;</span><span class="p">;</span>
<span class="n">has</span> <span class="s">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="sx">q(A basic example of a validation.)</span><span class="p">;</span>

<span class="k">sub</span> <span class="nf">validate</span> <span class="p">{}</span>

<span class="mi">1</span><span class="p">;</span>
</pre></div>

<p>This validation doesn't do anything useful and will not record results when
executed. But it satisfies all of the basic requirements to be loaded as a new
Validation into Conch. You could run <code>make run</code> in <code>Conch/</code> and this validation
will be loaded into the system.</p>
<p>Valid validations must be sub-classes of the <code>Conch::Validation</code> module, and
the package must be under the <code>Conch::Validation</code> namespace. Validations use
the <a href="https://metacpan.org/pod/Mojo::Base"><code>Mojo::Base</code></a> module for sub-classing
and to set fields with the <code>has</code> directive. The following fields are required
for every validation:</p>
<ul>
<li><code>name</code>: a short string name of the validation. The <code>name</code> and <code>version</code>
  values together must be unique for all validations in the system.</li>
<li><code>version</code>: an integer denoting the version of the validation for a given
  name. This field allows for supporting multiple versions of similar
  validations for legacy support.</li>
<li><code>category</code>: a short string signifier denoting the device component category
  being validated. Example categories are <code>BIOS</code>, <code>NET</code>, <code>DISK</code>, <code>CPU</code>,
  <code>RAM</code>. Upper case is used by convention.</li>
<li><code>description</code>: a longer, human-friendly description about the validation. The
  description should describe what is being validated and how.</li>
</ul>
<p>All validations must define the <code>validate</code> method. <code>validate</code> defines the logic
of the validation. In our example, it does nothing, but next we will define
validation logic and register results.</p>
<h2 id="writing-validation-logic">Writing validation logic<a class="headerlink" href="#writing-validation-logic" title="Permanent link">&para;</a></h2>
<p>The <code>validate</code> method defines the validation logic. When a validation is run in
the validation system, the <code>validate</code> method is called for each validation.</p>
<p>The <code>validate</code> method receives two arguments: a 'self' reference and a hash ref
of the data input to the validation. Like so:</p>
<div class="codehilite"><pre><span></span><span class="k">sub</span> <span class="nf">validate</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="c1"># assuming the input data has a &#39;product_name&#39; field</span>
    <span class="k">my</span> <span class="nv">$product_name</span> <span class="o">=</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">product_name</span><span class="p">};</span>
<span class="p">}</span>
</pre></div>

<p>The validation logic should register at least one validation result and can
register as many results as desired. Validation results can be registered with
the following methods with different effects:</p>
<ul>
<li>
<p><a href="https://github.com/joyent/conch/blob/master/Conch/docs/validation/BaseValidation.md#die"><code>$self-&gt;die('string')</code></a>:
  Stop execution of the validation and record a validation result with status
  'error'. This should be used when the validation cannot continue. For example,
  when expected values in the <code>$data</code> hash ref are not present, call
  <code>$self-&gt;die()</code> with a description of the expected value</p>
</li>
<li>
<p><a href="https://github.com/joyent/conch/blob/master/Conch/docs/validation/BaseValidation.md#fail"><code>$self-&gt;fail('string')</code></a>:
  Record a validation result with status 'fail' and continue execution of the
  validation. This may be used if some precondition is not satisfied but the
  validation should still continue.</p>
</li>
<li>
<p><a href="https://github.com/joyent/conch/blob/master/Conch/docs/validation/BaseValidation.md#register_result"><code>$self-&gt;register_result( expected =&gt; $a, got =&gt; $b, cmp =&gt; 'eq')</code></a>:
  this is the workhorse of validation logic. It takes an expected and 'got' value
  and compares them with the operator <code>cmp</code>. The list of available comparison
  operators can be <a href="https://github.com/joyent/conch/blob/master/Conch/docs/validation/BaseValidation.md#register_result">found in the documentation.</a></p>
</li>
</ul>
<p>For our example, let's validate that the input data reports that the device has
at least 1.21 gigawatts of power. This would be reported in JSON format and
de-serialized to the Perl hash ref provided as the <code>$data</code> argument. The input
data should look like <code>{ &quot;power&quot;: { &quot;gigawatts&quot; : &lt;number&gt; } }</code>. We must be
sure to check we have received the data in the format we expect so our
validation is verifying the expected values. Update your validation file to the
following:</p>
<div class="codehilite"><pre><span></span><span class="k">package</span> <span class="nn">Conch::Validation::MyValidation</span><span class="p">;</span>

<span class="k">use</span> <span class="nn">Mojo::Base</span> <span class="s">&#39;Conch::Validation&#39;</span><span class="p">;</span>

<span class="n">has</span> <span class="s">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;my_validation_name&#39;</span><span class="p">;</span>
<span class="n">has</span> <span class="s">&#39;version&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">has</span> <span class="s">&#39;category&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;EXAMPLE&#39;</span><span class="p">;</span>
<span class="n">has</span> <span class="s">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="sx">q(A basic example of a validation.)</span><span class="p">;</span>

<span class="k">sub</span> <span class="nf">validate</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$power</span> <span class="o">=</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">power</span><span class="p">};</span>

    <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">die</span><span class="p">(</span><span class="s">&quot;&#39;power&#39; key is required in the input data&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$power</span><span class="p">);</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">die</span><span class="p">(</span><span class="s">&quot;&#39;power&#39; value must be a hash&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="nb">ref</span><span class="p">(</span><span class="nv">$power</span><span class="p">)</span> <span class="ow">eq</span> <span class="s">&#39;HASH&#39;</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$gigawatts</span> <span class="o">=</span> <span class="nv">$power</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">gigawatts</span><span class="p">};</span>

    <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">die</span><span class="p">(</span><span class="s">&quot;&#39;gigawatts&#39; is required in the input data&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$gigawatts</span><span class="p">);</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="nb">die</span><span class="p">(</span><span class="err">&quot;</span><span class="s">&#39;gigawatts&#39;</span> <span class="n">must</span> <span class="n">be</span> <span class="n">a</span> <span class="n">number</span><span class="s">&#39;) unless ( $gigawatts =~ /\d+(\.\d+)?/ );</span>

<span class="s">    $self-&gt;register_result(</span>
<span class="s">        expected =&gt; 1.21,</span>
<span class="s">        got      =&gt; $gigawatts,</span>
<span class="s">        cmp      =&gt; &#39;</span><span class="o">&gt;=</span><span class="s">&#39;,</span>
<span class="s">        hint     =&gt; &#39;</span><span class="n">We</span> <span class="k">require</span> <span class="nn">at</span> <span class="n">least</span> <span class="mf">1.21</span> <span class="n">gigawatts</span> <span class="n">of</span> <span class="n">power</span> <span class="k">for</span> <span class="n">this</span> <span class="n">device</span><span class="err">&#39;</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="mi">1</span><span class="p">;</span>
</pre></div>

<h2 id="validating-input">Validating input<a class="headerlink" href="#validating-input" title="Permanent link">&para;</a></h2>
<p>As you might notice in the example, it can be quite tedious to validate every
field in the input data hash and call <code>$self-&gt;die</code> if it's not present.
Instead, you may optionally define a 'schema' field. If <code>schema</code> is defined
will validate the input data against the schema before calling <code>validate</code> if
the data is valid. Any schema errors will be registered as validation results
with 'error' status. </p>
<p>The schema is defined using <a href="http://json-schema.org">JSON-Schema</a>, written with
a Perl hash instead of a JSON string. You can find <a href="http://json-schema.org/example1.html">an easy JSON-Schema
tutorial here</a>. It covers everything you
should need to write a schema for a Conch Validation. </p>
<p><strong>NOTE:</strong> As the input data is required to be a hash, the root-level <code>{ type =&gt;
'object', properties =&gt; {...} }</code> is omitted when defining validation schemas.
All top-level keys in the <code>schema</code> hash are assumed to be properties of the
hash. All top-level keys are also marked as <code>required</code>.</p>
<p>We can re-write our example validation using a schema like so:</p>
<div class="codehilite"><pre><span></span><span class="k">package</span> <span class="nn">Conch::Validation::MyValidation</span><span class="p">;</span>

<span class="k">use</span> <span class="nn">Mojo::Base</span> <span class="s">&#39;Conch::Validation&#39;</span><span class="p">;</span>

<span class="n">has</span> <span class="s">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;my_validation_name&#39;</span><span class="p">;</span>
<span class="n">has</span> <span class="s">&#39;version&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">has</span> <span class="s">&#39;category&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;EXAMPLE&#39;</span><span class="p">;</span>
<span class="n">has</span> <span class="s">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="sx">q(A basic example of a validation.)</span><span class="p">;</span>

<span class="c1"># NOTICE the &#39;sub {}&#39; wrapping the hash!</span>
<span class="c1"># Mojo::Base requires non-scalar fields be defined this way.</span>
<span class="n">has</span> <span class="s">&#39;schema&#39;</span> <span class="o">=&gt;</span> <span class="k">sub</span> <span class="p">{</span>
    <span class="p">{</span>
        <span class="n">power</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="n">type</span>       <span class="o">=&gt;</span> <span class="s">&#39;object&#39;</span><span class="p">,</span>
            <span class="n">required</span>   <span class="o">=&gt;</span> <span class="p">[</span><span class="s">&#39;gigawatts&#39;</span><span class="p">],</span>
            <span class="n">properties</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">gigawatts</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&#39;number&#39;</span> <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">sub</span> <span class="nf">validate</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="c1"># we can safely assume this hash path is present because it was verified with the schema</span>
    <span class="k">my</span> <span class="nv">$gigawatts</span> <span class="o">=</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">power</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">gigawatts</span><span class="p">};</span>

    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">register_result</span><span class="p">(</span>
        <span class="n">expected</span> <span class="o">=&gt;</span> <span class="mf">1.21</span><span class="p">,</span>
        <span class="n">got</span>      <span class="o">=&gt;</span> <span class="nv">$gigawatts</span><span class="p">,</span>
        <span class="ow">cmp</span>      <span class="o">=&gt;</span> <span class="s">&#39;&gt;=&#39;</span><span class="p">,</span>
        <span class="n">hint</span>     <span class="o">=&gt;</span> <span class="s">&#39;We require at least 1.21 gigawatts of power for this device&#39;</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="mi">1</span><span class="p">;</span>
</pre></div>

<p>If the input data does not satisfy the schema, a validation result with status
'error' will be recorded describing all schema errors and the <code>validate</code> method
will not be executed.</p>
<h2 id="dispatching-on-device-attributes">Dispatching on Device Attributes<a class="headerlink" href="#dispatching-on-device-attributes" title="Permanent link">&para;</a></h2>
<p>Your validation may need to evaluate differently based on attributes of the
device under validation, such as the device hardware product, device location,
and device settings. The <code>$self</code> reference provides methods for accessing
details for the device under validation</p>
<ul>
<li><code>$self-&gt;device</code>: the <code>Conch::Model::Device</code> object representing the device
  under validation</li>
<li><code>$self-&gt;device_settings</code>: a hash ref of the device settings currently stored
  for the device under validation</li>
<li><code>$self-&gt;device_location</code>: the <code>Conch::Class::DeviceLocation</code> object
  representing the location of the device under validation</li>
<li><code>$self-&gt;hardware_product_vendor</code>: a string of hardware product vendor name of
  the expected hardware product for the device</li>
<li><code>$self-&gt;hardware_product_name</code>: a string of the hardware product name of the
  expected hardware product for the device</li>
<li><code>$self-&gt;hardware_product_profile</code>: the <code>Conch::Class:HardareProductProfile</code>
  object representing the hardware product profile of the expected hardware
  product for the device</li>
</ul>
<p>If these methods are used and the device <em>does not</em> have details (for example,
if a device does not have a location assigned), the method will call
<code>$self-&gt;die</code> with a description of the condition that caused it to fail. This
is good! You can program conditions expecting a device to have a location, and
it will fail automatically if the device isn't assigned yet. No need to write
your own conditional checking logic.</p>
<p>A common validation use-case is comparing values reported, such as the amount
of RAM, to the value expected by the hardware product profile. For our
validation, let's assume that we require 1.21 gigawatts per PSU (stay with me
here), where the number of PSUs is specified by the <code>psu_total</code> field of the
hardware product profile. To add further complexity, this is only applied for
devices with the product name 'DMC-12'. For all other produce names, we require
the normal 1.21 gigawatts. Let's update our validation with this more complicated
logic:</p>
<div class="codehilite"><pre><span></span><span class="k">package</span> <span class="nn">Conch::Validation::MyValidation</span><span class="p">;</span>

<span class="k">use</span> <span class="nn">Mojo::Base</span> <span class="s">&#39;Conch::Validation&#39;</span><span class="p">;</span>

<span class="n">has</span> <span class="s">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;my_validation_name&#39;</span><span class="p">;</span>
<span class="n">has</span> <span class="s">&#39;version&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">has</span> <span class="s">&#39;category&#39;</span> <span class="o">=&gt;</span> <span class="s">&#39;EXAMPLE&#39;</span><span class="p">;</span>
<span class="n">has</span> <span class="s">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="sx">q(A basic example of a validation.)</span><span class="p">;</span>

<span class="c1"># NOTICE the &#39;sub {}&#39; wrapping the hash!</span>
<span class="c1"># Mojo::Base requires non-scalar fields be defined this way.</span>
<span class="n">has</span> <span class="s">&#39;schema&#39;</span> <span class="o">=&gt;</span> <span class="k">sub</span> <span class="p">{</span>
    <span class="p">{</span>
        <span class="n">power</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="n">type</span>     <span class="o">=&gt;</span> <span class="s">&#39;object&#39;</span><span class="p">,</span>
            <span class="n">required</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s">&#39;gigawatts&#39;</span><span class="p">],</span>
            <span class="n">properties</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="n">gigawatts</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&#39;number&#39;</span> <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">sub</span> <span class="nf">validate</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="c1"># we can safely assume this hash path is present because it was verified with the schema</span>
    <span class="k">my</span> <span class="nv">$gigawatts</span> <span class="o">=</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">power</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">gigawatts</span><span class="p">};</span>

    <span class="k">my</span> <span class="nv">$expected_gigawatts</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="n">hardware_product_name</span> <span class="ow">eq</span> <span class="s">&#39;DMC-12&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$expected_gigawatts</span> <span class="o">=</span> <span class="mf">1.21</span> <span class="o">*</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="nn">hardware_product_profile</span><span class="o">-&gt;</span><span class="n">psu_total</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$expected_gigawatts</span> <span class="o">=</span> <span class="mf">1.21</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">register_result</span><span class="p">(</span>
        <span class="n">expected</span> <span class="o">=&gt;</span> <span class="nv">$expected_gigawatts</span><span class="p">,</span>
        <span class="n">got</span>      <span class="o">=&gt;</span> <span class="nv">$gigawatts</span><span class="p">,</span>
        <span class="ow">cmp</span>      <span class="o">=&gt;</span> <span class="s">&#39;&gt;=&#39;</span><span class="p">,</span>
        <span class="n">hint</span>     <span class="o">=&gt;</span> <span class="s">&quot;We require at least $expected_gigawatts gigawatts for this device&quot;</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="mi">1</span><span class="p">;</span>
</pre></div>

<h2 id="writing-unit-tests-for-validations">Writing unit tests for Validations<a class="headerlink" href="#writing-unit-tests-for-validations" title="Permanent link">&para;</a></h2>
<p>Writing unit tests for your new validation is strongly encouraged. A test
harness is provided to make this process easy and practical. At minimum, you
specify your validation module name and an array of tests cases to execute with
your validation.</p>
<p>A test cases is simply a hash with fields describing the input and expected
results. Each test case must specify a <code>data</code> field for the input data, which
must be a hash ref. The test case should specify a <code>description</code> string field
to help with documenting the test case and debugging test failures. A test case
should then define one or many of the following:</p>
<ul>
<li><code>dies</code>: If set to 1, we expect the validation to call <code>$self-&gt;die</code> based on
  the input. Defaults to 0.</li>
<li><code>success_num</code>: The number of results with status 'pass' to be registered
  based on the input. Defaults to 0.</li>
<li><code>failure_num</code>: The number of results with status 'fail' to be registered
  based on the input. Defaults to 0.</li>
</ul>
<p>An example to test the validation we've written is provided below. To test this
yourself, write to the file <code>t/validation/my_validation_v1.t</code> and run <code>carton
exec prove t/validation/my_validation_v1.t</code>.</p>
<div class="codehilite"><pre><span></span><span class="k">use</span> <span class="nn">Test::More</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Test::Conch::Validation</span><span class="p">;</span>

<span class="n">test_validation</span><span class="p">(</span>
    <span class="s">&#39;Conch::Validation::MyValidation&#39;</span><span class="p">,</span>
    <span class="n">hardware_product</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#39;Test Product&#39;</span> <span class="p">},</span>
    <span class="n">cases</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&#39;Providing no input data dies&#39;</span><span class="p">,</span>
            <span class="n">data</span>        <span class="o">=&gt;</span> <span class="p">{},</span>
            <span class="n">dies</span>        <span class="o">=&gt;</span> <span class="mi">1</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&#39;If &#39;</span><span class="n">power</span><span class="s">&#39; is not a hash, it dies&#39;</span><span class="p">,</span>
            <span class="n">data</span>        <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">power</span> <span class="o">=&gt;</span> <span class="s">&#39;bad power&#39;</span><span class="p">},</span>
            <span class="n">dies</span>        <span class="o">=&gt;</span> <span class="mi">1</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&#39;If &#39;</span><span class="n">gigawatts</span><span class="s">&#39; is not a number, it dies&#39;</span><span class="p">,</span>
            <span class="n">data</span>        <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">power</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">gigawatts</span> <span class="o">=&gt;</span> <span class="s">&#39;bad&#39;</span> <span class="p">}</span> <span class="p">},</span>
            <span class="n">dies</span>        <span class="o">=&gt;</span> <span class="mi">1</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&#39;If &#39;</span><span class="n">gigawatts</span><span class="s">&#39; is not at least 1.21, it fails&#39;</span><span class="p">,</span>
            <span class="n">data</span>        <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">power</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">gigawatts</span> <span class="o">=&gt;</span> <span class="mf">1.00</span> <span class="p">}</span> <span class="p">},</span>
            <span class="n">failure_num</span> <span class="o">=&gt;</span> <span class="mi">1</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&#39;If &#39;</span><span class="n">gigawatts</span><span class="s">&#39; is exactly least 1.21, it passes&#39;</span><span class="p">,</span>
            <span class="n">data</span>        <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">power</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">gigawatts</span> <span class="o">=&gt;</span> <span class="mf">1.21</span> <span class="p">}</span> <span class="p">},</span>
            <span class="n">success_num</span> <span class="o">=&gt;</span> <span class="mi">1</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&#39;If &#39;</span><span class="n">gigawatts</span><span class="s">&#39; is more than 1.21, it passes&#39;</span><span class="p">,</span>
            <span class="n">data</span>        <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">power</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">gigawatts</span> <span class="o">=&gt;</span> <span class="mf">1.22</span> <span class="p">}</span> <span class="p">},</span>
            <span class="n">success_num</span> <span class="o">=&gt;</span> <span class="mi">1</span>
        <span class="p">},</span>
    <span class="p">]</span>
<span class="p">);</span>

<span class="n">done_testing</span><span class="p">();</span>
</pre></div>

<p>This tests the basic logic, but doesn't test the edge case we introduced with
1.21 gigawatts multiplied by the number of PSUs for devices with the hardware
product name 'DMC-12'. The validation harness also allows us to provide fake
objects, like hardware product and hardware profile, to be used in the
validation under test. This is done by defining named arguments in the
<code>test_validation</code> function like <code>hardware_product</code>. <a href="https://github.com/joyent/conch/blob/master/Conch/docs/validation/TestingValidations.md">The list of available
named arguments and an example are given in the documentation for the test
harness</a>.</p>
<p>In the same file, after the <code>test_validation()</code> call and before
<code>done_testing();</code>, we add tests for the edge case:</p>
<div class="codehilite"><pre><span></span><span class="n">test_validation</span><span class="p">(</span>
    <span class="s">&#39;Conch::Validation::MyValidation&#39;</span><span class="p">,</span>
    <span class="n">hardware_product</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#39;DMC-12&#39;</span><span class="p">,</span>
        <span class="c1"># profile has 2 PSUs</span>
        <span class="n">profile</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">psu_total</span> <span class="o">=&gt;</span> <span class="mi">2</span> <span class="p">},</span>
    <span class="p">},</span>
    <span class="n">cases</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&#39;If &#39;</span><span class="n">gigawatts</span><span class="s">&#39; is 1.21, it fails&#39;</span><span class="p">,</span>
            <span class="n">data</span>        <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">power</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">gigawatts</span> <span class="o">=&gt;</span> <span class="mf">1.21</span> <span class="p">}</span> <span class="p">},</span>
            <span class="n">failure_num</span> <span class="o">=&gt;</span> <span class="mi">1</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&#39;If &#39;</span><span class="n">gigawatts</span><span class="s">&#39; is exactly 2 * 1.21 = 2.42, it passes&#39;</span><span class="p">,</span>
            <span class="n">data</span>        <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">power</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">gigawatts</span> <span class="o">=&gt;</span> <span class="mf">2.42</span> <span class="p">}</span> <span class="p">},</span>
            <span class="n">success_num</span> <span class="o">=&gt;</span> <span class="mi">1</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&#39;If &#39;</span><span class="n">gigawatts</span><span class="s">&#39; is more than 2.42, it passes&#39;</span><span class="p">,</span>
            <span class="n">data</span>        <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">power</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">gigawatts</span> <span class="o">=&gt;</span> <span class="mf">2.5</span> <span class="p">}</span> <span class="p">},</span>
            <span class="n">success_num</span> <span class="o">=&gt;</span> <span class="mi">1</span>
        <span class="p">},</span>
    <span class="p">]</span>
<span class="p">);</span>
</pre></div>

<h2 id="deploying-the-validation">Deploying the Validation<a class="headerlink" href="#deploying-the-validation" title="Permanent link">&para;</a></h2>
<p>A Conch Validation must be deployed in the production Conch instance to be
available. After you've written and tested your validation, commit it on a
branch and <a href="https://github.com/joyent/conch/pulls">create a pull request on the Conch Github
repository</a>. Request someone from the
Conch team to review and merge it.</p>
<p>The validation will be deployed in the next <a href="https://github.com/joyent/conch/releases">versioned
release</a> after it has been merged
into master.</p>
<p><em>NOTE</em>: As of 2018-04-18, device reports are validated during ingest against
one of two validation plans, named <code>Conch v1 Legacy Plan: Switch</code> and <code>Conch v1
Legacy Plan: Server</code>. <a href="https://github.com/joyent/conch/blob/master/Conch/conch.conf.dist#L37-L73">The validations associated with these plans are configured
in the Conch configuration file</a>.
These validations plans may be modified via the API, but the plans will be
reset to the specified configuration every time the Conch service is restarted.
To include your new validation permanently as part of one of these plans, the
configuration file must be updated in configuration management and deployed.</p>
<h2 id="using-validations-with-the-conch-shell">Using Validations with the Conch Shell<a class="headerlink" href="#using-validations-with-the-conch-shell" title="Permanent link">&para;</a></h2>
<p>The <a href="https://github.com/joyent/conch-shell">Conch Shell</a> CLI tool provides
commands for managing validations and validation plans. <a href="https://github.com/joyent/conch-shell/releases">You may download the
latest version of a compiled binary for your system
here.</a>. Save the binary
somewhere on your $PATH. To set up and authenticate your account, run the
command <code>conch profile create</code> once installed.</p>
<h3 id="listing-validations">Listing validations<a class="headerlink" href="#listing-validations" title="Permanent link">&para;</a></h3>
<p><code>conch validations</code> lists all available validations.  Each validation has an
UUID ID. In commands on a single validation, you may use the full idea or the
first 8 hexadecimal digits of the UUID (all characters before the first dash).
For example, <code>39cb3ab6-1963-4c9a-94ea-e2d9258d8be0</code> may be shortened to
<code>39cb3ab6</code>.</p>
<h3 id="testing-a-validation-with-a-device">Testing a validation with a device<a class="headerlink" href="#testing-a-validation-with-a-device" title="Permanent link">&para;</a></h3>
<p><code>conch validation VALIDATION_ID test DEVICE_ID</code> tests a validation against a
device. The <code>DEVICE_ID</code> is a device's serial number. The command returns a
table of the validation results from running the validation. <em>This does not
store the validations results in the database</em>. This command is intended for
testing a new validation or new reporting agent code.</p>
<p><code>conch validation VALIDATION_ID test DEVICE_ID</code> receives the input
data to validate from STDIN. The input data must be in JSON format. For
example, you can do any of the following to test a validation:</p>
<div class="codehilite"><pre><span></span>conch validation 39cb3ab6 <span class="nb">test</span> COFFEE &lt; report_data.json

<span class="c1"># &#39;jo&#39; is https://github.com/jpmens/jo</span>
jo <span class="s1">&#39;power[gigawatts]=1.21&#39;</span>  <span class="p">|</span> conch validation 39cb3ab6 <span class="nb">test</span> COFFEE

conch validation 39cb3ab6 <span class="nb">test</span> COFFEE <span class="s">&lt;&lt;EOF</span>
<span class="s">{</span>
<span class="s">    &quot;power&quot; : {</span>
<span class="s">        &quot;gigawatts&quot; : 1.21</span>
<span class="s">    }</span>
<span class="s">}</span>
<span class="s">EOF</span>
</pre></div>

<p>Optionally, you also start the command (hitting enter after the command) and
type in your input data and end with <code>^D</code> (Control-D)</p>
<div class="codehilite"><pre><span></span>conch validation 39cb3ab6 test COFFEE&lt;ENTER&gt;
{
    &quot;power&quot; : {
        &quot;gigawatts&quot; : 1.21
    }
}
^D
</pre></div>

<h3 id="creating-and-managing-validation-plans">Creating and managing validation plans<a class="headerlink" href="#creating-and-managing-validation-plans" title="Permanent link">&para;</a></h3>
<p>Validation plans are collections of validations. Validations plans are is
executed during device report ingest and by orchestration workflows.
Validations are independent and un-ordered within a validation plan. A given
validation may be in 0 or many validation plans, and a validation plan may have
0, 1, or many validations associated with it.</p>
<p>Only users who are global admins (i.e., <a href="https://github.com/joyent/rfd/blob/master/rfd/0134/README.md">they have an <code>Administrator</code> role for
the GLOBAL workspace</a> may
create and manage validation plans. However, anyone with a Conch account may
list and test validation plans.</p>
<p><code>conch validation-plans get</code> lists all available validation plans. Like
validation IDs, you may shorten the UUID to the first 8 characters in commands.</p>
<p><code>conch validation-plans create --name NAME_OF_NEW_VALIDATION_PLAN --description
DESCRIPTION_OF_PLAN</code> creates a new validation plan. A new validation plan will
have no validations associated with it.</p>
<p><code>conch validation-plan PLAN_ID validations</code> lists all validations associated
with the plan.</p>
<p><code>conch validation-plan PLAN_ID add-validation VALIDATION_ID</code> associates a
validation with the validation plan. You may use a short ID for the
<code>VALIDATION_ID</code> field.</p>
<p><code>conch validation-plan PLAN_ID remove-validation VALIDATION_ID</code> removes an
associated validation from the validation plan. You may use a short ID for the
<code>VALIDATION_ID</code> field.</p>
<h3 id="testing-validation-plans">Testing validation plans<a class="headerlink" href="#testing-validation-plans" title="Permanent link">&para;</a></h3>
<p><code>conch validation-plan VALIDATION_PLAN_ID test DEVICE_ID</code> tests a validation
plan against a device. Any authenticated user may test a validation plan
against a device. Testing with a validation plan works identically to testing
with a single validation, except the input data is processed by all validations
in the validation plan.  This command is useful for verifying a device report
can satisfy the schemas for all validations in a validation plans when
developing a reporting agent.</p>
<p>Like testing a validation, the command receives the JSON-formatted input data
from STDIN. Any of the following options work.</p>
<div class="codehilite"><pre><span></span>conch validation-plan 39cb3ab6 <span class="nb">test</span> COFFEE &lt; report_data.json

<span class="c1"># &#39;jo&#39; is https://github.com/jpmens/jo</span>
jo <span class="s1">&#39;power[gigawatts]=1.21&#39;</span> <span class="p">|</span> conch validation-plan 39cb3ab6 <span class="nb">test</span> COFFEE

conch validation-plan 39cb3ab6 <span class="nb">test</span> COFFEE <span class="s">&lt;&lt;EOF</span>
<span class="s">{</span>
<span class="s">    &quot;power&quot; : {</span>
<span class="s">        &quot;gigawatts&quot; : 1.21</span>
<span class="s">    }</span>
<span class="s">}</span>
<span class="s">EOF</span>

conch validation 39cb3ab6 <span class="nb">test</span> COFFEE&lt;ENTER&gt;
<span class="o">{</span>
    <span class="s2">&quot;power&quot;</span> : <span class="o">{</span>
        <span class="s2">&quot;gigawatts&quot;</span> : <span class="m">1</span>.21
    <span class="o">}</span>
<span class="o">}</span>
^D
</pre></div>

<h2 id="tips-for-writing-validations">Tips for Writing Validations<a class="headerlink" href="#tips-for-writing-validations" title="Permanent link">&para;</a></h2>
<p>Below are some tips for writing effective validations.</p>
<h3 id="provide-user-friendly-hints">Provide user-friendly hints<a class="headerlink" href="#provide-user-friendly-hints" title="Permanent link">&para;</a></h3>
<p><code>$self-&gt;die</code>, <code>$self-&gt;fail</code>, and <code>$self-&gt;register_result</code> can be called with an
<code>hint</code> attribute to provide a user-friendly message to help diagnose and fix
the issue. For example:</p>
<div class="codehilite"><pre><span></span><span class="nv">$self</span><span class="o">-&gt;</span><span class="n">register_result</span><span class="p">(</span>
    <span class="n">expected</span> <span class="o">=&gt;</span> <span class="nv">$expected_temp</span><span class="p">,</span>
    <span class="n">got</span>      <span class="o">=&gt;</span> <span class="nv">$temp</span><span class="p">,</span>
    <span class="ow">cmp</span>      <span class="o">=&gt;</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span>
    <span class="n">hint</span>     <span class="o">=&gt;</span> <span class="s">&quot;This device is too hot! Make it cooler!&quot;</span>
<span class="p">);</span>
</pre></div>

<h3 id="die-fast-and-loud">Die fast and loud<a class="headerlink" href="#die-fast-and-loud" title="Permanent link">&para;</a></h3>
<p>If there's some condition you don't expect, use <code>$self-&gt;die</code>. Don't try to
write complicated logic to handle all possible conditions. This leads into the
next tip.</p>
<h3 id="write-small-validations">Write <em>small</em> validations<a class="headerlink" href="#write-small-validations" title="Permanent link">&para;</a></h3>
<p>Don't try to write a validation for all possible hardware products. Validations
can be mixed-and-matched in validation plans, and those plans associated with
different hardware products.  For example, instead of writing conditional logic
to handle the case for the "DMC-12" product, we could have written two separate
validations: one for products where we expect 1.21 * $number_of_PSUs gigawatts
and one where 1.21 gigawatts is always expected.</p>
<p>The advantage is we don't have to change the validation if there's a new
hardware product where same edge case should apply. We only need to associate
the validation with a validation plan the hardware product should use.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../" title="Overview" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Overview
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.a59e2a89.js"></script>
      
      <script>app.initialize({version:"0.17.4",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>