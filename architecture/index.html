



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.4, mkdocs-material-2.9.2">
    
    
      
        <title>Architecture - Conch</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.ba0fd1a6.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.6079476c.css">
      
      
        
        
        <meta name="theme-color" content="#ff7043">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="deep-orange" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#components" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Conch" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Conch
              </span>
              <span class="md-header-nav__topic">
                Architecture
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    Conch
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../about/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Architecture
      </label>
    
    <a href="./" title="Architecture" class="md-nav__link md-nav__link--active">
      Architecture
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#components" title="Components" class="md-nav__link">
    Components
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api" title="API" class="md-nav__link">
    API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ui" title="UI" class="md-nav__link">
    UI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conch-shell" title="Conch Shell" class="md-nav__link">
    Conch Shell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database" title="Database" class="md-nav__link">
    Database
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relay" title="Relay" class="md-nav__link">
    Relay
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#diagnostic-relay-device-drd" title="Diagnostic Relay Device (DRD)" class="md-nav__link">
    Diagnostic Relay Device (DRD)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relay-service-vm" title="Relay Service (VM)" class="md-nav__link">
    Relay Service (VM)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#livesys" title="Livesys" class="md-nav__link">
    Livesys
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../features/" title="Features" class="md-nav__link">
      Features
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../roadmap/" title="Roadmap" class="md-nav__link">
      Roadmap
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Using Conch
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Using Conch
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../usage/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../usage/ui/" title="Web UI" class="md-nav__link">
      Web UI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../usage/cli/" title="CLI" class="md-nav__link">
      CLI
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Conch Relay Devices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Conch Relay Devices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../relay/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../relay/setup/" title="Setup" class="md-nav__link">
      Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../relay/usage/" title="Usage" class="md-nav__link">
      Usage
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../relay/status/" title="Status and Icons" class="md-nav__link">
      Status and Icons
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Development
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Development
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../development/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../development/validations/" title="Writing Validations" class="md-nav__link">
      Writing Validations
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#components" title="Components" class="md-nav__link">
    Components
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api" title="API" class="md-nav__link">
    API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ui" title="UI" class="md-nav__link">
    UI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conch-shell" title="Conch Shell" class="md-nav__link">
    Conch Shell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database" title="Database" class="md-nav__link">
    Database
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relay" title="Relay" class="md-nav__link">
    Relay
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#diagnostic-relay-device-drd" title="Diagnostic Relay Device (DRD)" class="md-nav__link">
    Diagnostic Relay Device (DRD)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relay-service-vm" title="Relay Service (VM)" class="md-nav__link">
    Relay Service (VM)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#livesys" title="Livesys" class="md-nav__link">
    Livesys
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Architecture</h1>
                
                <h2 id="components">Components<a class="headerlink" href="#components" title="Permanent link">&para;</a></h2>
<h3 id="api">API<a class="headerlink" href="#api" title="Permanent link">&para;</a></h3>
<p>Conch's core is its REST API. The API is documented <a href="https://conch.joyent.us/doc">here</a>.</p>
<p>It exposes basic CRUD for all resources we know how to manage:</p>
<ul>
<li>Users</li>
<li>Workspaces</li>
<li>Datacenters, rooms (soon: cages)</li>
<li>Racks</li>
<li>Hardware products (servers, switches)</li>
<li>Devices</li>
<li>Validation failures</li>
<li>Stats</li>
</ul>
<p>Workspaces are arbitrary collections of Datacenter Rooms or Racks. This is
useful for a number of reasons: You can define workspaces for AZs, for
expansions, or for specific builds. You can invite specific users to a given
workspace, allowing you to limit the devices an outside vendor can interact
with. Workspaces are a very powerful, useful primitive.</p>
<p>It also includes report ingestion and validation endpoints. These feed into the
<a href="https://github.com/joyent/conch/blob/master/Conch/docs/validation/BaseValidation.md">validation engine</a>
which allows us to decide if a device is healthy or not, based off its hardware
profile, environmental or arbitrary data.</p>
<p>Writing and testing new validations is documented
<a href="https://github.com/joyent/conch/blob/master/Conch/docs/validation/Guide.md">here</a>.</p>
<p>The APIs are written in Perl's <a href="https://mojolicious.org/">Mojolicious framework</a>, and are available
<a href="https://github.com/joyent/conch">here</a>.</p>
<p>A basic workspace-aware stats framework is available <a href="https://github.com/joyent/conch-stats">here</a>.</p>
<h3 id="ui">UI<a class="headerlink" href="#ui" title="Permanent link">&para;</a></h3>
<p>The Conch UI is rapidly evolving. Its initial design was targeted at hardware
integrators and datacenter operation staff -- the main focus was on defining
rack layout and identifying problems with devices in those racks.</p>
<p>As time goes on, the UI will expand to include better search and reporting
options, and more advanced features like datacenter, rack, and BOM design.</p>
<p>The UI is an API consumer, and is not magical in any respect.</p>
<p>The UI is written in <a href="https://mithril.js.org/">Mithril.js</a>, and is available
<a href="https://github.com/joyent/conch-ui">here</a>.</p>
<h3 id="conch-shell">Conch Shell<a class="headerlink" href="#conch-shell" title="Permanent link">&para;</a></h3>
<p>The Conch Shell is a CLI tool provides many useful primitives for interacting
with the Conch API. It supports multiple user profiles and endpoints, and has
JSON output options to allow users to create arbitrary processes with it.</p>
<p>The Shell has many options. Here are some examples of using it:</p>
<ul>
<li><a href="https://gist.github.com/bdha/1a625f22e922cbba315b660f30c3681c">Overview</a></li>
<li><a href="https://gist.github.com/bdha/5bcb8bf8321026c68e5b15c76bc77470">Rack slot contents</a></li>
<li><a href="https://gist.github.com/bdha/ea93ddd19be5afa7ad21f52bfd6c7bde">Validation plans</a></li>
<li><a href="https://gist.github.com/bdha/ac41b6953325580b614ff4e44b09c095">Hardware profiles</a></li>
</ul>
<p>The Shell is an API consumer, and is not magical in any respect.</p>
<p>The Shell is written on Go, and is available <a href="https://github.com/joyent/conch-shell">here</a>.</p>
<h3 id="database">Database<a class="headerlink" href="#database" title="Permanent link">&para;</a></h3>
<p>Conch's core database is Postgres.</p>
<p>Conch uses a <a href="https://github.com/joyent/conch/tree/master/sql">simple migration system</a>
for managing database changes.</p>
<h3 id="relay">Relay<a class="headerlink" href="#relay" title="Permanent link">&para;</a></h3>
<p>Conch Relay is a simple API service that takes traffic from the livesys or other
Conch clients and interacts with the Conch API. It is currently used mainly in
integration and initial validation stages of datacenter builds.</p>
<p>The Relay codebase is currently closed, but is planned on being open ASAP.</p>
<p>The Relay comes in two flavors:</p>
<h4 id="diagnostic-relay-device-drd">Diagnostic Relay Device (DRD)<a class="headerlink" href="#diagnostic-relay-device-drd" title="Permanent link">&para;</a></h4>
<p>AKA Preflight Relay Device (PRD).</p>
<p>This is a physical deployment of the Relay service. DRDs are simple x86 or
Rasberry Pi devices that run the Relay and various other agents for standing up
and configuring racks.</p>
<p>In this mode, we support configuration of TORs. As such, the device is plugged
into individual racks. In certain configurations, the DRD must have serial
cables plugged into the TORs to configure them. Other switches only require
ethernet access to do so.</p>
<p>This mode is exclusing used in off-site integration facilities, before the racks
are shipped to the datacenter.</p>
<p>The Relay also includes a support tunnel feature, so engineers can remotely log
into the integration facility if needed.</p>
<h4 id="relay-service-vm">Relay Service (VM)<a class="headerlink" href="#relay-service-vm" title="Permanent link">&para;</a></h4>
<p>In this mode, the Relay runs in a SmartOS or VM, and operates in a post-shipment
re-validation mode. In the future, this mode may also allow the planned
production inventory agent to submit reports to the Conch APIs from a local
service.</p>
<h3 id="livesys">Livesys<a class="headerlink" href="#livesys" title="Permanent link">&para;</a></h3>
<p>The live system is a read-only Linux image the Relay PXE boots on servers.</p>
<p>The livesys includes a number of agents:</p>
<ul>
<li>Firmware upgrade</li>
<li>Reporter</li>
<li>Rebooter</li>
<li>Burnin</li>
<li>...</li>
</ul>
<p>The livesys is configured via <code>chef-solo</code> cookbooks.</p>
<p>The livesys codebase is currently closed, but is planned on being open ASAP.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../about/" title="Overview" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Overview
              </span>
            </div>
          </a>
        
        
          <a href="../features/" title="Features" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Features
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.a59e2a89.js"></script>
      
      <script>app.initialize({version:"0.17.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>